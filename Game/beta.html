<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pok√©mon Game - Menu</title>
  <style>
    :root {
      --bg-color: #f5f5f5;
      --text-color: #333;
      --card-bg: #fff;
      --border-color: #ccc;
      --primary-blue: #3B4CCA;
      --primary-yellow: #ffcc00;
      --silhouette: #333;
    }

    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      transition: background-color 0.3s, color 0.3s;
    }

    /* --- Modalit√† Scura --- */
    body.dark-mode {
      --bg-color: #333;
      --text-color: #f0f0f0;
      --card-bg: #444;
      --border-color: #555;
      --silhouette: #000;
    }

    /* --- Contenitori di Pagina --- */
    .page-container {
      display: none; /* Nascosto di default */
      padding: 20px;
      padding-top: 60px; /* Spazio per il pulsante "indietro" */
      position: relative;
    }

    .back-to-menu {
      position: absolute;
      top: 15px;
      left: 15px;
      padding: 8px 15px;
      font-size: 16px;
      cursor: pointer;
      background-color: var(--primary-blue);
      color: white;
      border: none;
      border-radius: 8px;
    }

    h1, h2 {
      color: var(--primary-yellow);
    }

    /* --- Menu Principale --- */
    #mainMenu {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
    }
    #mainMenu h1 {
      font-size: 3.5rem;
      text-shadow: 2px 2px 4px #333;
    }
    .menu-options button {
      display: block;
      width: 250px;
      margin: 15px auto;
      padding: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      border: none;
      border-radius: 10px;
      background-color: var(--primary-blue);
      color: white;
      transition: background-color 0.3s;
    }
    .menu-options button:hover {
      background-color: #5E6ABC;
    }

    /* --- Gioco (Stili Originali) --- */
    .container {
      display: flex;
      justify-content: center;
      gap: 50px;
      margin-top: 30px;
    }
    .pokemon { text-align: center; }
    .pokemon img {
      width: 100px;
      height: 100px;
      image-rendering: pixelated;
    }
    .options { margin-top: 20px; }
    .options button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #score, #highscore {
      font-size: 20px;
      margin-top: 15px;
    }
    #gameOverPopup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #gameOverPopup .popup-content {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      max-width: 360px;
      color: var(--text-color); /* Colore testo per popup */
    }
    #timer { font-size: 22px; color: #d32f2f; }
    #wrongDetails { white-space: pre-wrap; }

    /* --- Account & Pok√©dex --- */
    #statsSummary {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 25px;
      font-size: 1.2rem;
    }
    #statsSummary div { margin: 10px 0; }

    #pokedexSearch {
      padding: 10px;
      width: 250px;
      font-size: 16px;
      margin-bottom: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      color: var(--text-color);
    }
    .pokedex-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      justify-items: center;
    }
    .pokedex-pokemon {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 110px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .pokedex-pokemon:hover { transform: scale(1.05); }
    .pokedex-pokemon img {
      width: 80px;
      height: 80px;
      image-rendering: pixelated;
    }
    .pokedex-pokemon-name {
      margin-top: 8px;
      font-size: 14px;
      word-wrap: break-word;
    }
    /* Stile per Pok√©mon Bloccati */
    .pokedex-pokemon.locked img {
      filter: brightness(0);
      opacity: 0.8;
    }
    .pokedex-pokemon.locked .pokedex-pokemon-name {
      color: var(--silhouette);
    }

    /* Modal Pok√©dex */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-color);
      border-radius: 12px;
      padding: 20px;
      max-width: 400px;
      width: 90%;
      text-align: left;
      position: relative;
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal img {
      display: block;
      margin: 0 auto 10px auto;
      width: 120px;
      height: 120px;
      image-rendering: pixelated;
    }
    .stat { margin: 5px 0; }
    .stat-name { font-size: 14px; margin-bottom: 2px; }
    .stat-bar { height: 10px; background-color: #eee; border-radius: 5px; overflow: hidden; }
    .stat-bar-inner { height: 100%; background-color: #4caf50; width: 0%; }
    /* Modal per Pok√©mon Bloccati */
    .modal img.locked {
      filter: brightness(0);
    }

    /* --- Impostazioni --- */
    .settings-group {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin: 20px auto;
      max-width: 400px;
      text-align: left;
    }
    .settings-group label {
      font-size: 1.2rem;
      font-weight: bold;
      display: block;
      margin-bottom: 10px;
    }
    .settings-group select, .settings-group .language-options {
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      color: var(--text-color);
    }
    .language-options button {
      font-size: 24px;
      border: none;
      background: none;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 5px;
      transition: background-color 0.2s;
    }
    .language-options button:hover {
      background-color: rgba(0,0,0,0.1);
    }
    .language-options button.active {
      background-color: var(--primary-blue);
      color: white;
    }
    
    @media (max-width: 480px) {
      #mainMenu h1 { font-size: 2.5rem; }
      .menu-options button { width: 80%; }
      .container { flex-direction: column; gap: 10px; }
      #gameOverPopup .popup-content { width: 90%; }
    }
  </style>
</head>
<body>

  <div id="mainMenu">
    <h1>Pok√©mon Game</h1>
    <div class="menu-options">
      <button id="playButton">Game</button>
      <button id="accountButton">Account</button>
      <button id="settingsButton">Settings</button>
    </div>
  </div>

  <div id="gameContainer" class="page-container">
    <button class="back-to-menu" data-translate="backToMenu">&larr; Menu</button>
    <h1 id="title"></h1>
    <div id="score"></div>
    <div id="highscore"></div>
    <div id="timer"></div>

    <div class="container">
      <div id="player" class="pokemon">
        <img id="player-sprite" src="" alt="Pok√©mon" />
        <div id="player-name"></div>
      </div>
      <div id="opponent" class="pokemon">
        <img id="opponent-sprite" src="" alt="Pok√©mon" />
        <div id="opponent-name"></div>
      </div>
    </div>
    <div id="comparison" style="margin-top: 20px; font-size: 18px;"></div>
    <div class="options">
      <button id="greater"></button>
      <button id="not-greater"></button>
    </div>
  </div>

  <div id="accountContainer" class="page-container">
    <button class="back-to-menu" data-translate="backToMenu">&larr; Menu</button>
    <h2 data-translate="account">Account</h2>

    <div id="statsSummary">
      <div><span data-translate="highScore">Record</span>: <span id="accountHighScore">0</span></div>
      <div><span data-translate="gamesPlayed">Partite Giocate</span>: <span id="accountGamesPlayed">0</span></div>
    </div>
    
    <h3 data-translate="pokedex">Pok√©dex</h3>
    <input type="text" id="pokedexSearch" placeholder="Cerca Pok√©mon...">
    <div id="pokedexGrid" class="pokedex-grid"></div>

    <div id="pokemonModal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2 id="modalName"></h2>
        <img id="modalImage" src="" alt="">
        <div id="modalStats"></div>
      </div>
    </div>
  </div>

  <div id="settingsContainer" class="page-container">
    <button class="back-to-menu" data-translate="backToMenu">&larr; Menu</button>
    <h2 data-translate="settings">Settings</h2>

    <div class="settings-group">
      <label for="difficultySetting" data-translate="difficulty">Difficolt√†</label>
      <select id="difficultySetting">
        <option value="easy" data-translate="easy">Facile</option>
        <option value="medium" data-translate="medium">Medio</option>
        <option value="hard" data-translate="hard">Difficile</option>
      </select>
    </div>

    <div class="settings-group">
      <label for="themeSetting" data-translate="theme">Tema</label>
      <select id="themeSetting">
        <option value="system" data-translate="system">Sistema</option>
        <option value="light" data-translate="light">Chiaro</option>
        <option value="dark" data-translate="dark">Scuro</option>
      </select>
    </div>

    <div class="settings-group">
      <label data-translate="language">Lingua</label>
      <div id="languageSelector" class="language-options">
        </div>
    </div>
  </div>

  <div id="gameOverPopup">
    <div class="popup-content">
      <h2 id="gameOverTitle">Game Over!</h2>
      <p id="finalScore"></p>
      <p id="highScoreMessage"></p>
      <div id="wrongDetails"></div>
      <button id="closePopup">Chiudi</button>
    </div>
  </div>


  <script>
    // --- CHIAVI LOCALSTORAGE ---
    const HIGHSCORE_KEY = "highScore";
    const GAMES_PLAYED_KEY = "gamesPlayed";
    const UNLOCKED_POKEMON_KEY = "unlockedPokemon";
    const LANG_KEY = "lang";
    const THEME_KEY = "theme";
    const DIFFICULTY_KEY = "difficulty";

    // --- VARIABILI GLOBALI ---
    let pokemonList = [];
    let unlockedPokemon = [];
    let score = 0;
    let gamesPlayed = 0;
    let highScore = 0;
    let gameOver = false;
    let timer;
    let timeLeft = 10;
    let t = {}; // Oggetto traduzioni corrente
    let lang = "it";
    let difficulty = "easy";
    let currentComparison = null; // Memorizza la comparazione corrente

    // --- OGGETTO TRADUZIONI (INTEGRATO) ---
    const translations = {
      "it": {
        "title": "Gioco Pok√©mon - Confronto Statistiche", "score": "Punteggio", "record": "Record", "time": "Tempo", "yes": "S√¨", "no": "No", "gameOver": "Game Over!", "newRecord": "üéâ Nuovo record!", "currentRecord": "Record attuale", "close": "Chiudi", "timeout": "Tempo scaduto!", "wrong": "Hai sbagliato!", "play": "Gioca", "account": "Account", "settings": "Impostazioni", "backToMenu": "Menu", "gamesPlayed": "Partite Giocate", "pokedex": "Pok√©dex", "difficulty": "Difficolt√†", "easy": "Facile", "medium": "Medio", "hard": "Difficile", "theme": "Tema", "system": "Sistema", "light": "Chiaro", "dark": "Scuro", "language": "Lingua", "search": "Cerca Pok√©mon..."
      },
      "en": {
        "title": "Pok√©mon Game - Stat Comparison", "score": "Score", "record": "High Score", "time": "Time", "yes": "Yes", "no": "No", "gameOver": "Game Over!", "newRecord": "üéâ New Record!", "currentRecord": "Current record", "close": "Close", "timeout": "Time‚Äôs up!", "wrong": "Wrong!", "play": "Play", "account": "Account", "settings": "Settings", "backToMenu": "Menu", "gamesPlayed": "Games Played", "pokedex": "Pok√©dex", "difficulty": "Difficulty", "easy": "Easy", "medium": "Medium", "hard": "Hard", "theme": "Theme", "system": "System", "light": "Light", "dark": "Dark", "language": "Language", "search": "Search Pok√©mon..."
      },
      "es": {
        "title": "Juego Pok√©mon - Comparar Stats", "score": "Puntuaci√≥n", "record": "R√©cord", "time": "Tiempo", "yes": "S√≠", "no": "No", "gameOver": "¬°Fin del juego!", "newRecord": "üéâ ¬°Nuevo r√©cord!", "currentRecord": "R√©cord actual", "close": "Cerrar", "timeout": "¬°Se acab√≥ el tiempo!", "wrong": "¬°Incorrecto!", "play": "Jugar", "account": "Cuenta", "settings": "Ajustes", "backToMenu": "Men√∫", "gamesPlayed": "Partidas Jugadas", "pokedex": "Pok√©dex", "difficulty": "Dificultad", "easy": "F√°cil", "medium": "Medio", "hard": "Dif√≠cil", "theme": "Tema", "system": "Sistema", "light": "Claro", "dark": "Oscuro", "language": "Idioma", "search": "Buscar Pok√©mon..."
      },
      "de": {
        "title": "Pok√©mon-Spiel - Statistikvergleich", "score": "Punkte", "record": "Rekord", "time": "Zeit", "yes": "Ja", "no": "Nein", "gameOver": "Spiel vorbei!", "newRecord": "üéâ Neuer Rekord!", "currentRecord": "Aktueller Rekord", "close": "Schlie√üen", "timeout": "Zeit ist um!", "wrong": "Falsch!", "play": "Spielen", "account": "Konto", "settings": "Einstellungen", "backToMenu": "Men√º", "gamesPlayed": "Gespielte Spiele", "pokedex": "Pok√©dex", "difficulty": "Schwierigkeit", "easy": "Einfach", "medium": "Mittel", "hard": "Schwer", "theme": "Thema", "system": "System", "light": "Hell", "dark": "Dunkel", "language": "Sprache", "search": "Pok√©mon suchen..."
      },
      "pt": {
        "title": "Jogo Pok√©mon - Compara√ß√£o de Estat√≠sticas", "score": "Pontua√ß√£o", "record": "Recorde", "time": "Tempo", "yes": "Sim", "no": "N√£o", "gameOver": "Fim de jogo!", "newRecord": "üéâ Novo recorde!", "currentRecord": "Recorde atual", "close": "Fechar", "timeout": "Tempo esgotado!", "wrong": "Errado!", "play": "Jogar", "account": "Conta", "settings": "Configura√ß√µes", "backToMenu": "Menu", "gamesPlayed": "Jogos Jogados", "pokedex": "Pok√©dex", "difficulty": "Dificuldade", "easy": "F√°cil", "medium": "M√©dio", "hard": "Dif√≠cil", "theme": "Tema", "system": "Sistema", "light": "Claro", "dark": "Escuro", "language": "Idioma", "search": "Pesquisar Pok√©mon..."
      },
      "fr": {
        "title": "Jeu Pok√©mon - Comparaison de Statistiques", "score": "Score", "record": "Record", "time": "Temps", "yes": "Oui", "no": "Non", "gameOver": "Partie termin√©e !", "newRecord": "üéâ Nouveau record !", "currentRecord": "Record actuel", "close": "Fermer", "timeout": "Temps √©coul√© !", "wrong": "Faux !", "play": "Jouer", "account": "Compte", "settings": "Param√®tres", "backToMenu": "Menu", "gamesPlayed": "Parties jou√©es", "pokedex": "Pok√©dex", "difficulty": "Difficult√©", "easy": "Facile", "medium": "Moyen", "hard": "Difficile", "theme": "Th√®me", "system": "Syst√®me", "light": "Clair", "dark": "Sombre", "language": "Langue", "search": "Chercher Pok√©mon..."
      },
      "ru": {
        "title": "–ò–≥—Ä–∞ –ü–æ–∫–µ–º–æ–Ω - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫", "score": "–°—á—ë—Ç", "record": "–†–µ–∫–æ—Ä–¥", "time": "–í—Ä–µ–º—è", "yes": "–î–∞", "no": "–ù–µ—Ç", "gameOver": "–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!", "newRecord": "üéâ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!", "currentRecord": "–¢–µ–∫—É—â–∏–π —Ä–µ–∫–æ—Ä–¥", "close": "–ó–∞–∫—Ä—ã—Ç—å", "timeout": "–í—Ä–µ–º—è –≤—ã—à–ª–æ!", "wrong": "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!", "play": "–ò–≥—Ä–∞—Ç—å", "account": "–ê–∫–∫–∞—É–Ω—Ç", "settings": "–ù–∞—Å—Ç—Ä–æ–π–∫–∏", "backToMenu": "–ú–µ–Ω—é", "gamesPlayed": "–°—ã–≥—Ä–∞–Ω–æ –∏–≥—Ä", "pokedex": "–ü–æ–∫–µ–¥–µ–∫—Å", "difficulty": "–°–ª–æ–∂–Ω–æ—Å—Ç—å", "easy": "–õ–µ–≥–∫–æ", "medium": "–°—Ä–µ–¥–Ω–µ", "hard": "–°–ª–æ–∂–Ω–æ", "theme": "–¢–µ–º–∞", "system": "–°–∏—Å—Ç–µ–º–∞", "light": "–°–≤–µ—Ç–ª–∞—è", "dark": "–¢—ë–º–Ω–∞—è", "language": "–Ø–∑—ã–∫", "search": "–ù–∞–π—Ç–∏ –ø–æ–∫–µ–º–æ–Ω–∞..."
      },
      "zh": {
        "title": "ÂÆùÂèØÊ¢¶Ê∏∏Êàè - Â±ûÊÄßÂØπÊØî", "score": "ÂàÜÊï∞", "record": "ÊúÄÈ´òÂàÜ", "time": "Êó∂Èó¥", "yes": "ÊòØ", "no": "Âê¶", "gameOver": "Ê∏∏ÊàèÁªìÊùüÔºÅ", "newRecord": "üéâ Êñ∞Á∫™ÂΩïÔºÅ", "currentRecord": "ÂΩìÂâçÁ∫™ÂΩï", "close": "ÂÖ≥Èó≠", "timeout": "Êó∂Èó¥Âà∞ÔºÅ", "wrong": "ÈîôËØØÔºÅ", "play": "Áé©", "account": "Â∏êÊà∑", "settings": "ËÆæÁΩÆ", "backToMenu": "ËèúÂçï", "gamesPlayed": "Áé©ËøáÁöÑÊ∏∏Êàè", "pokedex": "ÂÆùÂèØÊ¢¶ÂõæÈâ¥", "difficulty": "ÈöæÂ∫¶", "easy": "ÁÆÄÂçï", "medium": "‰∏≠Á≠â", "hard": "Âõ∞Èöæ", "theme": "‰∏ªÈ¢ò", "system": "Á≥ªÁªü", "light": "ÊµÖËâ≤", "dark": "Ê∑±Ëâ≤", "language": "ËØ≠Ë®Ä", "search": "ÊêúÁ¥¢ÂÆùÂèØÊ¢¶..."
      },
      "ja": {
        "title": "„Éù„Ç±„É¢„É≥„Ç≤„Éº„É† - „Çπ„ÉÜ„Éº„Çø„ÇπÊØîËºÉ", "score": "„Çπ„Ç≥„Ç¢", "record": "„Éè„Ç§„Çπ„Ç≥„Ç¢", "time": "ÊôÇÈñì", "yes": "„ÅØ„ÅÑ", "no": "„ÅÑ„ÅÑ„Åà", "gameOver": "„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÔºÅ", "newRecord": "üéâ Êñ∞Ë®òÈå≤ÔºÅ", "currentRecord": "ÁèæÂú®„ÅÆË®òÈå≤", "close": "Èñâ„Åò„Çã", "timeout": "ÊôÇÈñìÂàá„ÇåÔºÅ", "wrong": "ÈñìÈÅï„ÅÑÔºÅ", "play": "„Éó„É¨„Éº", "account": "„Ç¢„Ç´„Ç¶„É≥„Éà", "settings": "Ë®≠ÂÆö", "backToMenu": "„É°„Éã„É•„Éº", "gamesPlayed": "„Éó„É¨„Ç§„Åó„Åü„Ç≤„Éº„É†", "pokedex": "„Éù„Ç±„É¢„É≥Âõ≥Èëë", "difficulty": "Èõ£ÊòìÂ∫¶", "easy": "Á∞°Âçò", "medium": "ÊôÆÈÄö", "hard": "Èõ£„Åó„ÅÑ", "theme": "„ÉÜ„Éº„Éû", "system": "„Ç∑„Çπ„ÉÜ„É†", "light": "„É©„Ç§„Éà", "dark": "„ÉÄ„Éº„ÇØ", "language": "Ë®ÄË™û", "search": "„Éù„Ç±„É¢„É≥„ÇíÊ§úÁ¥¢..."
      },
      "ko": {
        "title": "Ìè¨ÏºìÎ™¨ Í≤åÏûÑ - Ïä§ÌÉØ ÎπÑÍµê", "score": "Ï†êÏàò", "record": "ÏµúÍ≥† Ï†êÏàò", "time": "ÏãúÍ∞Ñ", "yes": "Ïòà", "no": "ÏïÑÎãàÏò§", "gameOver": "Í≤åÏûÑ Ïò§Î≤Ñ!", "newRecord": "üéâ Ïã†Í∏∞Î°ù!", "currentRecord": "ÌòÑÏû¨ Í∏∞Î°ù", "close": "Îã´Í∏∞", "timeout": "ÏãúÍ∞Ñ Ï¢ÖÎ£å!", "wrong": "ÌãÄÎ†∏ÏäµÎãàÎã§!", "play": "ÌîåÎ†àÏù¥", "account": "Í≥ÑÏ†ï", "settings": "ÏÑ§Ï†ï", "backToMenu": "Î©îÎâ¥", "gamesPlayed": "ÌîåÎ†àÏù¥Ìïú Í≤åÏûÑ", "pokedex": "Ìè¨ÏºìÎ™¨ ÎèÑÍ∞ê", "difficulty": "ÎÇúÏù¥ÎèÑ", "easy": "Ïâ¨ÏõÄ", "medium": "Ï§ëÍ∞Ñ", "hard": "Ïñ¥Î†§ÏõÄ", "theme": "ÌÖåÎßà", "system": "ÏãúÏä§ÌÖú", "light": "ÎùºÏù¥Ìä∏", "dark": "Îã§ÌÅ¨", "language": "Ïñ∏Ïñ¥", "search": "Ìè¨ÏºìÎ™¨ Í≤ÄÏÉâ..."
      },
      "fi": {
        "title": "Pok√©mon-peli - Tilastojen Vertailu", "score": "Pisteet", "record": "Enn√§tys", "time": "Aika", "yes": "Kyll√§", "no": "Ei", "gameOver": "Peli ohi!", "newRecord": "üéâ Uusi enn√§tys!", "currentRecord": "Nykyinen enn√§tys", "close": "Sulje", "timeout": "Aika loppui!", "wrong": "V√§√§rin!", "play": "Pelaa", "account": "Tili", "settings": "Asetukset", "backToMenu": "Valikko", "gamesPlayed": "Pelatut pelit", "pokedex": "Pok√©dex", "difficulty": "Vaikeustaso", "easy": "Helppo", "medium": "Normaali", "hard": "Vaikea", "theme": "Teema", "system": "J√§rjestelm√§", "light": "Vaalea", "dark": "Tumma", "language": "Kieli", "search": "Etsi Pok√©mon..."
      },
      // Nomi delle Statistiche per tutte le lingue
      "statNames": {
        "it": { "hp": "HP", "attack": "Attacco", "defense": "Difesa", "spattack": "Attacco Speciale", "spdefense": "Difesa Speciale", "speed": "Velocit√†" },
        "en": { "hp": "HP", "attack": "Attack", "defense": "Defense", "spattack": "Sp. Attack", "spdefense": "Sp. Defense", "speed": "Speed" },
        "es": { "hp": "HP", "attack": "Ataque", "defense": "Defensa", "spattack": "Atq. Esp.", "spdefense": "Def. Esp.", "speed": "Velocidad" },
        "de": { "hp": "KP", "attack": "Angriff", "defense": "Verteidigung", "spattack": "Spezial-Angriff", "spdefense": "Spezial-Verteidigung", "speed": "Initiative" },
        "pt": { "hp": "HP", "attack": "Ataque", "defense": "Defesa", "spattack": "Ataque Esp.", "spdefense": "Defesa Esp.", "speed": "Velocidade" },
        "fr": { "hp": "PV", "attack": "Attaque", "defense": "D√©fense", "spattack": "Attaque Sp√©.", "spdefense": "D√©fense Sp√©.", "speed": "Vitesse" },
        "ru": { "hp": "–û–ó", "attack": "–ê—Ç–∞–∫–∞", "defense": "–ó–∞—â–∏—Ç–∞", "spattack": "–°–ø–µ—Ü. –ê—Ç–∞–∫–∞", "spdefense": "–°–ø–µ—Ü. –ó–∞—â–∏—Ç–∞", "speed": "–°–∫–æ—Ä–æ—Å—Ç—å" },
        "zh": { "hp": "HP", "attack": "ÊîªÂáª", "defense": "Èò≤Âæ°", "spattack": "ÁâπÊîª", "spdefense": "ÁâπÈò≤", "speed": "ÈÄüÂ∫¶" },
        "ja": { "hp": "HP", "attack": "„Åì„ÅÜ„Åí„Åç", "defense": "„Åº„ÅÜ„Åé„Çá", "spattack": "„Å®„Åè„Åì„ÅÜ", "spdefense": "„Å®„Åè„Åº„ÅÜ", "speed": "„Åô„Å∞„ÇÑ„Åï" },
        "ko": { "hp": "HP", "attack": "Í≥µÍ≤©", "defense": "Î∞©Ïñ¥", "spattack": "ÌäπÏàòÍ≥µÍ≤©", "spdefense": "ÌäπÏàòÎ∞©Ïñ¥", "speed": "Ïä§ÌîºÎìú" },
        "fi": { "hp": "HP", "attack": "Hy√∂kk√§ys", "defense": "Puolustus", "spattack": "Erikoishy√∂kk√§ys", "spdefense": "Erikoispuolustus", "speed": "Nopeus" }
      }
    };
    const flagEmojis = {
      "it": "üáÆüáπ", "en": "üá¨üáß", "es": "üá™üá∏", "de": "üá©üá™", "pt": "üáµüáπ", "fr": "üá´üá∑", "ru": "üá∑üá∫", "zh": "üá®üá≥", "ja": "üáØüáµ", "ko": "üá∞üá∑", "fi": "üá´üáÆ"
    };

    // --- FUNZIONI DI NAVIGAZIONE ---
    function showPage(pageId) {
      // Nasconde tutte le pagine
      document.getElementById("mainMenu").style.display = "none";
      document.querySelectorAll(".page-container").forEach(page => {
        page.style.display = "none";
      });
      // Mostra la pagina richiesta
      const page = document.getElementById(pageId);
      if (page) {
        page.style.display = "block";
      }
    }

    // --- FUNZIONI DI IMPOSTAZIONE E CARICAMENTO ---
    document.addEventListener("DOMContentLoaded", () => {
      // 1. Carica i dati salvati
      loadSettings();
      
      // 2. Applica le traduzioni iniziali
      applyLanguage(lang);

      // 3. Applica il tema
      applyTheme(localStorage.getItem(THEME_KEY) || 'system');

      // 4. Carica dati di gioco
      loadGameData();
      
      // 5. Collega i listener di navigazione
      setupNavigationListeners();

      // 6. Collega i listener delle impostazioni
      setupSettingsListeners();

      // 7. Mostra il menu principale
      showPage("mainMenu");
    });

    function loadSettings() {
      // Lingua
      lang = localStorage.getItem(LANG_KEY) || navigator.language.slice(0, 2) || "en";
      if (!translations[lang]) lang = "en"; // Fallback se la lingua non √® supportata

      // Difficolt√†
      difficulty = localStorage.getItem(DIFFICULTY_KEY) || "easy";

      // Dati account
      highScore = parseInt(localStorage.getItem(HIGHSCORE_KEY) || 0);
      gamesPlayed = parseInt(localStorage.getItem(GAMES_PLAYED_KEY) || 0);
      unlockedPokemon = JSON.parse(localStorage.getItem(UNLOCKED_POKEMON_KEY) || "[]");
    }

    async function loadGameData() {
      try {
        const response = await fetch("pokemonList.json");
        if (!response.ok) throw new Error("Errore nel caricare pokemonList.json");
        pokemonList = await response.json();
      } catch (error) {
        console.error("Errore:", error);
        alert("Non √® stato possibile caricare la lista dei Pok√©mon.");
      }
    }

    function setupNavigationListeners() {
      document.getElementById("playButton").addEventListener("click", () => {
        showPage("gameContainer");
        startRound();
      });
      document.getElementById("accountButton").addEventListener("click", () => {
        loadAccountPage();
        showPage("accountContainer");
      });
      document.getElementById("settingsButton").addEventListener("click", () => {
        loadSettingsPage();
        showPage("settingsContainer");
      });

      document.querySelectorAll(".back-to-menu").forEach(button => {
        button.addEventListener("click", () => {
          clearInterval(timer); // Ferma il timer se si torna dal gioco
          showPage("mainMenu");
        });
      });

      document.getElementById("closePopup").onclick = () => {
        document.getElementById("gameOverPopup").style.display = "none";
        showPage("mainMenu"); // Torna al menu invece di ricaricare
      };
    }

    // --- FUNZIONI DI IMPOSTAZIONE (LINGUA, TEMA, DIFFICOLT√Ä) ---

    function applyLanguage(newLang) {
      lang = newLang;
      localStorage.setItem(LANG_KEY, lang);
      t = translations[lang] || translations.en;

      // Aggiorna tutti gli elementi con 'data-translate'
      document.querySelectorAll("[data-translate]").forEach(el => {
        const key = el.dataset.translate;
        if (t[key]) {
          el.innerText = t[key];
        }
      });

      // Aggiorna elementi specifici non-data
      document.title = t.title;
      // Menu
      document.getElementById("playButton").innerText = t.play;
      document.getElementById("accountButton").innerText = t.account;
      document.getElementById("settingsButton").innerText = t.settings;
      // Gioco
      document.getElementById("title").innerText = t.title;
      document.getElementById("greater").innerText = t.yes;
      document.getElementById("not-greater").innerText = t.no;
      document.getElementById("gameOverTitle").innerText = t.gameOver;
      document.getElementById("closePopup").innerText = t.close;
      document.getElementById("highscore").innerText = `${t.record}: ${highScore}`;
      document.getElementById("score").innerText = `${t.score}: ${score}`;
      // Account
      document.getElementById("pokedexSearch").placeholder = t.search;
      // Impostazioni
      loadSettingsPage(); // Ricarica i testi delle impostazioni
    }
    
    function applyTheme(theme) {
      document.body.classList.remove('dark-mode', 'light-mode');
      if (theme === 'dark') {
        document.body.classList.add('dark-mode');
      } else if (theme === 'light') {
        document.body.classList.add('light-mode');
      } else { // 'system'
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          document.body.classList.add('dark-mode');
        }
      }
    }
    
    function setupSettingsListeners() {
      const difficultySelect = document.getElementById("difficultySetting");
      const themeSelect = document.getElementById("themeSetting");
      const langSelector = document.getElementById("languageSelector");

      // Difficolt√†
      difficultySelect.addEventListener("change", (e) => {
        difficulty = e.target.value;
        localStorage.setItem(DIFFICULTY_KEY, difficulty);
      });

      // Tema
      themeSelect.addEventListener("change", (e) => {
        const newTheme = e.target.value;
        localStorage.setItem(THEME_KEY, newTheme);
        applyTheme(newTheme);
      });
      
      // Listener per il cambio tema di sistema
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        const savedTheme = localStorage.getItem(THEME_KEY) || 'system';
        if (savedTheme === 'system') {
          applyTheme('system');
        }
      });

      // Lingua
      langSelector.addEventListener("click", (e) => {
        const newLang = e.target.dataset.lang || e.target.parentElement.dataset.lang;
        if (newLang) {
          applyLanguage(newLang);
        }
      });
    }

    function loadSettingsPage() {
      // Imposta i valori salvati
      document.getElementById("difficultySetting").value = difficulty;
      document.getElementById("themeSetting").value = localStorage.getItem(THEME_KEY) || 'system';

      // Popola selettore lingua
      const langSelector = document.getElementById("languageSelector");
      langSelector.innerHTML = "";
      Object.keys(flagEmojis).forEach(key => {
        const button = document.createElement("button");
        button.dataset.lang = key;
        button.title = key.toUpperCase();
        button.innerHTML = flagEmojis[key];
        if (key === lang) button.classList.add("active");
        langSelector.appendChild(button);
      });
    }

    // --- FUNZIONI DI GIOCO ---

    function getSpriteUrl(name) {
      const normalized = name
        .toLowerCase()
        .replace(/-/g, "")
        .replace(/‚Äé /g, "")
        .replace(/‚ôÇ/g, "m")
        .replace(/‚ôÄ/g, "f")
        .replace(/[^a-z0-9 ]/g, "")
        .replace(/ /g, "-");
      return `https://play.pokemonshowdown.com/sprites/gen5/${normalized}.png`;
    }

    function getRandomPokemon() {
      return pokemonList[Math.floor(Math.random() * pokemonList.length)];
    }
    
    function getComparison(player, opponent) {
      const stats = ["hp", "attack", "defense", "spattack", "spdefense", "speed"];
      const stat = stats[Math.floor(Math.random() * stats.length)];
      return {
        stat,
        playerStat: player.stats[stat],
        opponentStat: opponent.stats[stat],
        isGreater: player.stats[stat] > opponent.stats[stat],
        player: player, // Salva l'oggetto Pok√©mon
        opponent: opponent
      };
    }

    function startTimer() {
      clearInterval(timer);
      
      // Imposta il tempo in base alla difficolt√†
      if (difficulty === "hard") timeLeft = 5;
      else if (difficulty === "medium") timeLeft = 7;
      else timeLeft = 10; // 'easy'
      
      document.getElementById("timer").innerText = `${t.time}: ${timeLeft}s`;

      timer = setInterval(() => {
        if (gameOver) {
          clearInterval(timer);
          return;
        }
        timeLeft--;
        document.getElementById("timer").innerText = `${t.time}: ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(timer);
          triggerGameOver(t.timeout, currentComparison); // Passa la comparazione
        }
      }, 1000);
    }
    
    function handleAnswer(isGreater) {
      if (gameOver) return;
      const comparison = currentComparison; // Usa la comparazione salvata
      const isCorrect = (isGreater && comparison.isGreater) || (!isGreater && !comparison.isGreater);
      
      if (isCorrect) {
        score++;
        document.getElementById("score").innerText = `${t.score}: ${score}`;
        // SBLOCCA IL POK√âMON!
        unlockPokemon(comparison.player.id);
        startRound();
      } else {
        triggerGameOver(t.wrong, comparison);
      }
    }

    function unlockPokemon(pokemonId) {
      if (!unlockedPokemon.includes(pokemonId)) {
        unlockedPokemon.push(pokemonId);
        localStorage.setItem(UNLOCKED_POKEMON_KEY, JSON.stringify(unlockedPokemon));
      }
    }
    
    function triggerGameOver(reason, comparison) {
      clearInterval(timer);
      gameOver = true;
      let newRecord = false;

      // Incrementa partite giocate
      gamesPlayed++;
      localStorage.setItem(GAMES_PLAYED_KEY, gamesPlayed);

      // Controlla record
      if (score > highScore) {
        highScore = score;
        localStorage.setItem(HIGHSCORE_KEY, highScore);
        newRecord = true;
      }

      // Aggiorna UI Popup
      document.getElementById("finalScore").innerText = `${t.score}: ${score}`;
      document.getElementById("highScoreMessage").innerText = newRecord ? t.newRecord : `${t.currentRecord}: ${highScore}`;

      const wrongEl = document.getElementById("wrongDetails");
      if (comparison) {
        const statLabel = (translations.statNames[lang] && translations.statNames[lang][comparison.stat]) || translations.statNames.en[comparison.stat] || comparison.stat;
        const playerVal = comparison.playerStat;
        const oppVal = comparison.opponentStat;
        const diff = Math.abs(playerVal - oppVal);
        const winner = playerVal === oppVal ? "Tie" : (playerVal > oppVal ? comparison.player.name : comparison.opponent.name);
        
        const detailsLines = [
          reason,
          `${comparison.player.name}: ${playerVal} ${statLabel}`,
          `${comparison.opponent.name}: ${oppVal} ${statLabel}`,
          `${winner === "Tie" ? "" : `Œî ${diff} ‚Äî ${winner} ${t.wins || 'wins'}`}` // 'wins' √® un fallback
        ].filter(Boolean);

        wrongEl.innerText = detailsLines.join("\n");
      } else {
        wrongEl.innerText = reason;
      }

      document.getElementById("gameOverPopup").style.display = "flex";
    }

    function startRound() {
      if (pokemonList.length === 0) return;
      gameOver = false;
      score = 0; // Resetta lo score all'inizio di una NUOVA partita
      document.getElementById("score").innerText = `${t.score}: ${score}`;
      document.getElementById("highscore").innerText = `${t.record}: ${highScore}`;

      const player = getRandomPokemon();
      let opponent = getRandomPokemon();
      if (pokemonList.length > 1) {
        while (opponent.id === player.id) {
          opponent = getRandomPokemon();
        }
      }

      currentComparison = getComparison(player, opponent); // Salva la comparazione

      // Aggiorna display
      document.getElementById("player-sprite").src = getSpriteUrl(player.name);
      document.getElementById("opponent-sprite").src = getSpriteUrl(opponent.name);
      document.getElementById("player-name").innerText = player.name;
      document.getElementById("opponent-name").innerText = opponent.name;

      const statLabel = (translations.statNames[lang] && translations.statNames[lang][currentComparison.stat]) || translations.statNames.en[currentComparison.stat] || currentComparison.stat;
      
      // Genera la domanda in base alla lingua
      let question = `Does ${player.name} have more ${statLabel} than ${opponent.name}?`;
      if (lang === 'it') question = `Il ${player.name} ha pi√π ${statLabel} di ${opponent.name}?`;
      if (lang === 'es') question = `¬ø${player.name} tiene m√°s ${statLabel} que ${opponent.name}?`;
      // ... Aggiungi altre se vuoi
      document.getElementById("comparison").innerText = question;

      // Collega i bottoni (meglio ri-collegare)
      document.getElementById("greater").onclick = () => handleAnswer(true);
      document.getElementById("not-greater").onclick = () => handleAnswer(false);
      startTimer();
    }
    
    // --- FUNZIONI ACCOUNT & POK√âDEX ---
    
    const pokedexGrid = document.getElementById('pokedexGrid');
    const searchInput = document.getElementById('pokedexSearch');
    const modal = document.getElementById('pokemonModal');
    const modalName = document.getElementById('modalName');
    const modalImage = document.getElementById('modalImage');
    const modalStats = document.getElementById('modalStats');
    const closeBtn = document.querySelector('.close-btn');

    function loadAccountPage() {
      // Aggiorna statistiche
      document.getElementById("accountHighScore").innerText = highScore;
      document.getElementById("accountGamesPlayed").innerText = gamesPlayed;
      
      // Carica il Pok√©dex
      displayPokedex(pokemonList);
    }
    
    function displayPokedex(list) {
      pokedexGrid.innerHTML = '';
      if (!list) return;

      list.forEach(pokemon => {
        const isUnlocked = unlockedPokemon.includes(pokemon.id);
        
        const div = document.createElement('div');
        div.className = 'pokedex-pokemon';
        
        const img = document.createElement('img');
        img.src = getSpriteUrl(pokemon.name);
        img.alt = pokemon.name;

        const name = document.createElement('div');
        name.className = 'pokedex-pokemon-name';

        if (isUnlocked) {
          name.textContent = pokemon.name;
          div.addEventListener('click', () => showPokemonModal(pokemon, true));
        } else {
          div.classList.add('locked');
          name.textContent = "???";
          div.addEventListener('click', () => showPokemonModal(pokemon, false));
        }

        div.appendChild(img);
        div.appendChild(name);
        pokedexGrid.appendChild(div);
      });
    }

    function showPokemonModal(pokemon, isUnlocked) {
      const statLabels = (translations.statNames[lang] || translations.statNames.en);

      if (isUnlocked) {
        modalName.textContent = `#${pokemon.id} ${pokemon.name}`;
        modalImage.src = getSpriteUrl(pokemon.name);
        modalImage.classList.remove('locked');
        modalStats.innerHTML = '';

        for (let stat in pokemon.stats) {
          const statDiv = document.createElement('div');
          statDiv.className = 'stat';
          const statLabel = statLabels[stat] || stat.toUpperCase();
          statDiv.innerHTML = `
            <div class="stat-name">${statLabel}: ${pokemon.stats[stat]}</div>
            <div class="stat-bar">
              <div class="stat-bar-inner" style="width: ${(pokemon.stats[stat] / 255) * 100}%"></div>
            </div>
          `;
          modalStats.appendChild(statDiv);
        }
      } else {
        modalName.textContent = `???`;
        modalImage.src = getSpriteUrl(pokemon.name); // Mostra lo sprite...
        modalImage.classList.add('locked'); // ...ma come silhouette
        modalStats.innerHTML = '';
        ['hp', 'attack', 'defense', 'spattack', 'spdefense', 'speed'].forEach(stat => {
          const statDiv = document.createElement('div');
          statDiv.className = 'stat';
          const statLabel = statLabels[stat] || stat.toUpperCase();
          statDiv.innerHTML = `
            <div class="stat-name">${statLabel}: ???</div>
            <div class="stat-bar">
              <div class="stat-bar-inner" style="width: 0%"></div>
            </div>
          `;
          modalStats.appendChild(statDiv);
        });
      }
      modal.style.display = 'flex';
    }

    // Listener Modal Pok√©dex
    closeBtn.addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', (e) => {
      if (e.target === modal) modal.style.display = 'none';
    });

    // Listener Ricerca Pok√©dex
    searchInput.addEventListener('input', () => {
      const term = searchInput.value.toLowerCase();
      const filtered = pokemonList.filter(p => p.name.toLowerCase().includes(term));
      displayPokedex(filtered);
    });

  </script>
</body>
</html>
